suite: reference data
templates:
  - drupal-deployment.yaml
  - drupal-volumes.yaml
  - reference-data-cron.yaml
tests:
  - it: has no reference data volume by default
    asserts:
    # Only one volume is defined.
    - hasDocuments:
        count: 1
      template: drupal-volumes.yaml
    - hasDocuments:
        count: 0
      template: reference-data-cron.yaml

  - it: takes reference data information
    set:
      environmentName: 'feature/FOO'
      referenceData:
        referenceEnvironment: 'feature/FOO'
        storage: 123Gi
        storageClassName: foo
        schedule: '0 1 2 3 *'
        command: "echo Hello World"
      php.env:
        foo: bar
    asserts:
    - hasDocuments:
        count: 2
      template: drupal-volumes.yaml
    - template: drupal-volumes.yaml
      documentIndex: 1
      equal:
        path: spec.storageClassName
        value: foo
    - template: drupal-volumes.yaml
      documentIndex: 1
      equal:
        path: spec.resources.requests.storage
        value: 123Gi

    - isKind:
        of: CronJob
      template: reference-data-cron.yaml
    - isKind:
        of: CronJob
      template: reference-data-cron.yaml

    - template: reference-data-cron.yaml
      contains:
        path: spec.jobTemplate.spec.template.spec.containers[0].env
        content:
          name: foo
          value: bar
    - template: reference-data-cron.yaml
      contains:
        path: spec.jobTemplate.spec.template.spec.volumes
        content:
          name: "drupal-public-files"
          persistentVolumeClaim:
            claimName: RELEASE-NAME-public-files
    - template: reference-data-cron.yaml
      equal:
        path: spec.schedule
        value: '0 1 2 3 *'
    - template: reference-data-cron.yaml
      equal:
        path: spec.jobTemplate.spec.template.spec.containers[0].args[0]
        value: "echo Hello World"



